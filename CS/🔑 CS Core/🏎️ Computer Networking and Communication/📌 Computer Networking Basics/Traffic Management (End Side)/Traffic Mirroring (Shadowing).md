# Traffic Mirroring (Shadowing)

[TOC]



## Res


## Intro
Traffic mirroring, also called shadowing, is a powerful concept that allows feature teams to bring changes to production with as little risk as possible. Mirroring sends a copy of live traffic to a mirrored service. The mirrored traffic happens out of band of the critical request path for the primary service.

é•œåƒæ˜¯ä¸€ç§æ•°æ®æµçš„ç›‘æ§æŠ€æœ¯ï¼Œé•œåƒæ—¢èƒ½å¯¹ç½‘ç»œä¸­çš„æ•°æ®æµé‡è¿›è¡Œç›‘æ§åˆ†æï¼Œåˆä¸å½±å“ç½‘ç»œä¸­çš„æ•°æ®æµé‡çš„æ­£å¸¸è½¬å‘ã€‚å¯¹äºç›‘æ§ç½‘ç»œä¿¡æ¯å®‰å…¨å’Œè§£å†³ç½‘ç»œæ•…éšœï¼Œé•œåƒæ˜¯ä¸€ç§å®ç”¨æ€§å¾ˆå¼ºçš„ç½‘ç»œç›‘æ§æŠ€æœ¯ã€‚å½“ç½‘ç»œä¸­å­˜åœ¨æ”»å‡»æˆ–å‡ºç°æ•…éšœæ—¶ï¼Œç½‘ç»œç®¡ç†å‘˜å¯ä»¥é€šè¿‡é•œåƒåŠŸèƒ½å¯¹æŠ¥æ–‡è¿›è¡Œè·å–å¹¶åˆ†æï¼Œæ‰¾åˆ°æ”»å‡»æºæˆ–æ•…éšœåŸå› ã€‚  
- æ ¹æ®é•œåƒæºçš„ä¸åŒï¼Œé•œåƒå¯ä»¥åˆ†ä¸ºç«¯å£é•œåƒã€æµé•œåƒã€[VLAN](https://info.support.huawei.com/info-finder/encyclopedia/zh/VLAN.html "VLAN")é•œåƒã€MACé•œåƒã€‚ä¾‹å¦‚ç«¯å£é•œåƒä»£è¡¨å°†æŒ‡å®šç«¯å£å…¥æ–¹å‘ã€å‡ºæ–¹å‘ã€æˆ–è€…å‡ºå…¥æ–¹å‘çš„æŠ¥æ–‡å¤åˆ¶åˆ°ç›®çš„ç«¯å£ã€‚  
- æ ¹æ®ç›®çš„ç«¯å£ä¸ç›‘æ§è®¾å¤‡é—´çš„è¿æ¥æ–¹å¼ï¼Œé•œåƒå¯ä»¥åˆ†ä¸ºæœ¬åœ°é•œåƒå’Œè¿œç¨‹é•œåƒã€‚

### Glossaries
- æºç«¯å£
	- æºç«¯å£æŒ‡è¢«ç›‘æ§è®¾å¤‡ä¸Šçš„æŒ‡å®šç«¯å£ï¼Œä¹Ÿç§°ä¸ºè¢«ç›‘æ§å£ã€‚åœ¨é•œåƒä¸­ï¼Œæºç«¯å£ä¸Šçš„æ•°æ®æµä¼šè¢«å¤åˆ¶ä¸€ä»½åˆ°ç›®çš„ç«¯å£ï¼Œç”¨äºç½‘ç»œåˆ†ææˆ–æ•…éšœæ’é™¤ã€‚
- ç›®çš„ç«¯å£ï¼ˆç›‘æ§/è§‚å¯Ÿç«¯å£ï¼‰
	- ç›®çš„ç«¯å£æ˜¯ä¸sç½‘ç»œåˆ†æè®¾å¤‡ç›¸è¿æ¥çš„ç«¯å£ã€‚ç›®çš„ç«¯å£ç”¨äºå°†æ¥æ”¶åˆ°çš„æºç«¯å£æŠ¥æ–‡è½¬å‘åˆ°ç½‘ç»œåˆ†æè®¾å¤‡ã€‚
- è¿œç¨‹é•œåƒVLAN
	- è¿œç¨‹é•œåƒVLANæ˜¯ä¸€ç§ç‰¹æ®Šçš„VLANï¼Œè¯¥VLANåªä¼ è¾“é•œåƒæŠ¥æ–‡ï¼Œä¸å¯¹æ­£å¸¸çš„ä¸šåŠ¡æ•°æ®è¿›è¡Œä¼ è¾“ã€‚
- æºè®¾å¤‡
	- æºè®¾å¤‡æ˜¯è¿œç¨‹ç«¯å£é•œåƒè§’è‰²ä¹‹ä¸€ï¼ŒæŒ‡æºç«¯å£æ‰€åœ¨çš„è®¾å¤‡ï¼Œè´Ÿè´£å°†æºç«¯å£çš„æŠ¥æ–‡å¤åˆ¶ä¸€ä»½åˆ°æºè®¾å¤‡çš„è¾“å‡ºç«¯å£ï¼Œä¼ è¾“ç»™ä¸­é—´è®¾å¤‡æˆ–ç›®çš„è®¾å¤‡ã€‚
- ä¸­é—´è®¾å¤‡
	- ä¸­é—´è®¾å¤‡æ˜¯è¿œç¨‹ç«¯å£é•œåƒè§’è‰²ä¹‹ä¸€ï¼ŒæŒ‡å¤„äºæºè®¾å¤‡å’Œç›®çš„è®¾å¤‡ä¹‹é—´çš„è®¾å¤‡ï¼Œè´Ÿè´£å°†é•œåƒæŠ¥æ–‡ä¼ è¾“ç»™ä¸‹ä¸€ä¸ªä¸­é—´è®¾å¤‡æˆ–ç›®çš„è®¾å¤‡ã€‚å¦‚æœæºè®¾å¤‡ä¸ç›®çš„è®¾å¤‡ç›´æ¥ç›¸è¿ï¼Œåˆ™ä¸å­˜åœ¨ä¸­é—´è®¾å¤‡ã€‚
- ç›®çš„è®¾å¤‡ï¼ˆç›‘æ§/è§‚å¯Ÿè®¾å¤‡ï¼‰
	- ç›®çš„è®¾å¤‡è¿œç¨‹ç«¯å£é•œåƒè§’è‰²ä¹‹ä¸€ï¼ŒæŒ‡è¿œç¨‹é•œåƒç›®çš„ç«¯å£æ‰€åœ¨çš„è®¾å¤‡ï¼Œè´Ÿè´£å°†ä¸­é—´è®¾å¤‡æˆ–è€…æºè®¾å¤‡æ¥æ”¶åˆ°çš„é•œåƒæŠ¥æ–‡è½¬å‘ç»™ç›‘æ§è®¾å¤‡ã€‚



## Mirroring Basics
### 1ï¸âƒ£ Port Mirroring
> ğŸ”— https://en.wikipedia.org/wiki/Port_mirroring

Port mirroring is used on a network switch to send a copy of network packets seen on one switch port (or an entire VLAN) to a network monitoring connection on another switch port. This is commonly used for network appliances that require monitoring of network traffic such as an intrusion detection system, passive probe or **real user monitoring (RUM)** technology that is used to support **application performance management (APM)**.
- Port mirroring on a Cisco Systems switch is generally referred to as **Switched Port Analyzer (SPAN)** or **Remote Switched Port Analyzer (RSPAN)**. Other vendors have different names for it, such as **Roving Analysis Port (RAP)** on 3Com switches.

Network engineers or administrators use port mirroring to analyze and debug data or diagnose errors on a network. It helps administrators keep a close eye on network performance and alerts them when problems occur. It can be used to mirror either inbound or outbound traffic (or both) on single or multiple interfaces.

#### Port Mirroring Working Principles
ç«¯å£é•œåƒæ˜¯å°†ç½‘ç»œè®¾å¤‡ä¸ŠæŒ‡å®šç«¯å£æ¥æ”¶æˆ–å‘é€çš„æŠ¥æ–‡å¤åˆ¶åˆ°ç›®çš„ç«¯å£ï¼Œå¯ä»¥åªå¤åˆ¶ç«¯å£æ¥æ”¶æˆ–è€…å‘é€çš„æŠ¥æ–‡ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å¤åˆ¶æ¥æ”¶å’Œå‘é€çš„æŠ¥æ–‡ã€‚æŒ‡å®šç«¯å£ç§°ä¸ºé•œåƒç«¯å£ï¼Œç›®çš„ç«¯å£ç§°ä¸ºè§‚å¯Ÿç«¯å£ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒDeviceAä¸Šçš„é•œåƒç«¯å£åœ¨æ¥æ”¶æˆ–å‘é€æŠ¥æ–‡çš„æ—¶å€™ï¼Œä¼šå°†æŠ¥æ–‡å¤åˆ¶ä¸€ä»½åˆ°è§‚å¯Ÿç«¯å£ã€‚è§‚å¯Ÿç«¯å£å†å°†å¤åˆ¶çš„åŸå§‹æŠ¥æ–‡å‘é€ç»™ç›‘æ§è®¾å¤‡ã€‚

![ç«¯å£é•œåƒç¤ºæ„å›¾](https://download.huawei.com/mdl/image/download?uuid=9637dd3f3d9646268851b69f9206fab1 "ç«¯å£é•œåƒç¤ºæ„å›¾")  
<small>ç«¯å£é•œåƒç¤ºæ„å›¾</small>

å½“è§‚å¯Ÿç«¯å£å’Œç›‘æ§è®¾å¤‡ç›´è¿æ—¶ç§°ä¸ºæœ¬åœ°é•œåƒã€‚å½“è§‚å¯Ÿç«¯å£å’Œç›‘æ§è®¾å¤‡é—´ä¸æ˜¯ç›´è¿ï¼Œè€Œæ˜¯é€šè¿‡äºŒå±‚ç½‘ç»œæˆ–ä¸‰å±‚ç½‘ç»œç›¸è¿æ—¶ç§°ä¸ºè¿œç¨‹é•œåƒã€‚Â 
- ç›®çš„ç«¯å£é€šè¿‡äºŒå±‚ç½‘ç»œä¸ç›‘æ§è®¾å¤‡ç›¸è¿çš„åœºæ™¯ç§°ä¸ºäºŒå±‚è¿œç¨‹é•œåƒ**RSPANï¼ˆRemote Switched Port Analyzerï¼‰**ã€‚
- ç›®çš„ç«¯å£é€šè¿‡ä¸‰å±‚ç½‘ç»œä¸ç›‘æ§è®¾å¤‡ç›¸è¿çš„åœºæ™¯ç§°ä¸ºä¸‰å±‚è¿œç¨‹é•œåƒ**ERSPANï¼ˆEncapsulated Remote Switched Port Analyzerï¼‰**ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿œç¨‹ç«¯å£é•œåƒåœºæ™¯ï¼Œè§‚å¯Ÿç«¯å£å°†å¤åˆ¶çš„æŠ¥æ–‡å‘é€ç»™ç›‘æ§è®¾å¤‡å‰ä¼šæ·»åŠ ä¸€å±‚[VLAN](https://info.support.huawei.com/info-finder/encyclopedia/zh/VLAN.html "VLAN")Â Tag æˆ–è¿›è¡Œ GRE(General Routing Encapsulation) å°è£…ï¼Œä¾¿äºå¤åˆ¶çš„æŠ¥æ–‡èƒ½å¤Ÿç©¿è¿‡ä¸­é—´çš„äºŒå±‚ç½‘ç»œ/ä¸‰å±‚ç½‘ç»œï¼Œåˆ°è¾¾ç›‘æ§è®¾å¤‡ã€‚

![è¿œç¨‹ç«¯å£é•œåƒç¤ºæ„å›¾](https://download.huawei.com/mdl/image/download?uuid=2d90e9ed70934d38bf437ff49712d141 "è¿œç¨‹ç«¯å£é•œåƒç¤ºæ„å›¾")  
<small>è¿œç¨‹ç«¯å£é•œåƒç¤ºæ„å›¾</small>

å…¶ä»–ç±»å‹çš„é•œåƒæ–¹å¼åŸç†ä¸ç«¯å£é•œåƒç±»ä¼¼ï¼Œä¾‹å¦‚ï¼š
- æµé•œåƒæ˜¯å°†ç¬¦åˆæŒ‡å®šè§„åˆ™çš„æŠ¥æ–‡æµå¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£ã€‚
- VLANé•œåƒæ˜¯å°†æŒ‡å®šVLANå†…æ‰€æœ‰æ´»åŠ¨æ¥å£çš„å…¥æ–¹å‘/å‡ºæ–¹å‘çš„æŠ¥æ–‡å¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£ã€‚
- MACé•œåƒå°†æŒ‡å®šVLANå†…æºMACåœ°å€æˆ–ç›®çš„MACåœ°å€ä¸ºæŒ‡å®šMACåœ°å€çš„æŠ¥æ–‡å¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£ã€‚

> ç«¯å£é•œåƒå’Œæµé•œåƒæœ‰ä»€ä¹ˆåŒºåˆ«?
> 
> ç«¯å£é•œåƒå’Œæµé•œåƒéƒ½å±äºé•œåƒã€‚åŒºåˆ«åœ¨äºï¼Œç«¯å£é•œåƒæ˜¯å°†é•œåƒç«¯å£æ‰€æœ‰å…¥æ–¹å‘/å‡ºæ–¹å‘çš„æŠ¥æ–‡å¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£ï¼›è€Œæµé•œåƒä¼šå¯¹ç«¯å£å…¥æ–¹å‘/å‡ºæ–¹å‘çš„æŠ¥æ–‡è¿›è¡Œç­›é€‰ï¼Œåªæœ‰æ»¡è¶³åŒ¹é…æ¡ä»¶çš„æŠ¥æ–‡æ‰ä¼šè¢«å¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£ã€‚æµé•œåƒä¸­å¯ä»¥é€šè¿‡[ACL](https://info.support.huawei.com/info-finder/encyclopedia/zh/ACL.html "ACL")æˆ–ç›¸å…³çš„é…ç½®å‘½ä»¤æŒ‡å®šå…·ä½“çš„åŒ¹é…æ¡ä»¶ã€‚


### 2ï¸âƒ£ Stream Mirroring
æµé•œåƒæ˜¯æŒ‡åœ¨è®¾å¤‡ä¸Šé…ç½®ä¸€å®šçš„è§„åˆ™ï¼Œå°†ç¬¦åˆè§„åˆ™çš„ç‰¹å®šä¸šåŠ¡æµå¤åˆ¶åˆ°è§‚å¯Ÿç«¯å£è¿›è¡Œåˆ†æå’Œç›‘æ§ã€‚

> æµé‡é•œåƒæ˜¯åœ¨ç«¯å£é•œåƒçš„åŸºç¡€ä¸Šï¼Œå°†æºç«¯å£ä¸ACLï¼ˆAccess Control Listï¼Œè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰å…³è”ï¼Œæ ¹æ®ACLè§„åˆ™å¯¹æŠ¥æ–‡è¿›è¡Œè¿‡æ»¤ï¼Œè¾¾åˆ°åªé•œåƒæŒ‡å®šæŠ¥æ–‡çš„ç›®çš„ã€‚æºç«¯å£åªæœ‰åŒ¹é…åˆ°ACLä¸­permitç±»å‹çš„ACEï¼ˆAccess Control Entryï¼Œè®¿é—®æ§åˆ¶æ¡ç›®ï¼‰çš„æŠ¥æ–‡æ‰èƒ½è¢«é•œåƒåˆ°ç›®çš„ç«¯å£ã€‚ä¸€ä¸ªæºç«¯å£åªèƒ½å…³è”ä¸€ä¸ªACLã€‚


### 3ï¸âƒ£ VLAN Mirroring
VLANé•œåƒæ˜¯æŒ‡å°†æŒ‡å®šVLANå†…æ‰€æœ‰æ´»åŠ¨æ¥å£çš„æŠ¥æ–‡é•œåƒåˆ°è§‚å¯Ÿç«¯å£ã€‚ç”¨æˆ·å¯ä»¥å¯¹æŸä¸ªVLANæˆ–è€…æŸäº›VLANå†…çš„æŠ¥æ–‡è¿›è¡Œç›‘æ§ã€‚

ç›®å‰ï¼Œåä¸ºSç³»åˆ—ç›’å¼äº¤æ¢æœºåœ¨åº”ç”¨VLANé•œåƒæ—¶ï¼Œä»…æ”¯æŒå°†VLANå†…æ´»åŠ¨æ¥å£å…¥æ–¹å‘çš„æŠ¥æ–‡é•œåƒåˆ°è§‚å¯Ÿç«¯å£ã€‚

åŒç«¯å£é•œåƒç±»ä¼¼ï¼Œæ ¹æ®ç›‘æ§è®¾å¤‡åœ¨ç½‘ç»œä¸­ä½ç½®çš„ä¸åŒï¼ŒVLANé•œåƒä¹Ÿå¯ä»¥åˆ†ä¸ºæœ¬åœ°VLANé•œåƒå’Œè¿œç¨‹VLANé•œåƒã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿œç¨‹VLANé•œåƒä¸­ï¼Œä¸»æœºæ‰€åœ¨VLANå’Œç”¨äºè½¬å‘é•œåƒæŠ¥æ–‡çš„ä¸­é—´äºŒå±‚ç½‘ç»œçš„VLANä¸èƒ½ç›¸åŒã€‚


### 4ï¸âƒ£ MAC Mirroring
MACé•œåƒæ˜¯æŒ‡å°†VLANå†…åŒ¹é…æŒ‡å®šæºæˆ–è€…ç›®çš„MACåœ°å€çš„æŠ¥æ–‡é•œåƒåˆ°è§‚å¯Ÿç«¯å£ã€‚MACåœ°å€é•œåƒæä¾›äº†ä¸€ç§æ›´åŠ ç²¾ç¡®çš„é•œåƒæ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥å¯¹ç½‘ç»œä¸­ç‰¹å®šè®¾å¤‡çš„æŠ¥æ–‡è¿›è¡Œç›‘æ§ã€‚

ç›®å‰ï¼Œåä¸ºSç³»åˆ—ç›’å¼äº¤æ¢æœºåœ¨åº”ç”¨MACé•œåƒæ—¶ï¼Œä»…æ”¯æŒå°†VLANå†…æ´»åŠ¨æ¥å£å…¥æ–¹å‘åŒ¹é…æŒ‡å®šæºæˆ–è€…ç›®çš„MACåœ°å€çš„æŠ¥æ–‡é•œåƒåˆ°è§‚å¯Ÿç«¯å£ã€‚



## Ref
[Port Mirroring | IBM]: https://www.ibm.com/docs/en/cloud-pak-system-w4600/2.3.3?topic=features-port-mirroring

[ğŸ‘ Mirroring | Istio]: https://istio.io/latest/docs/tasks/traffic-management/mirroring/

[Port mirroring | wikipedia]: https://en.wikipedia.org/wiki/Port_mirroring

[ğŸ‘ é•œåƒæ˜¯ä»€ä¹ˆ/ ç«¯å£é•œåƒæ¦‚è¿° | é”æ·ç½‘ç»œ]: https://www.ruijie.com.cn/jszl/90095/
[ğŸ‘ ä»€ä¹ˆæ˜¯é•œåƒï¼Ÿ| åä¸º]: https://info.support.huawei.com/info-finder/encyclopedia/zh/é•œåƒ.html
[ğŸ‘ ç«¯å£é•œåƒ]: https://cshihong.github.io/2017/11/16/ç«¯å£é•œåƒ/
