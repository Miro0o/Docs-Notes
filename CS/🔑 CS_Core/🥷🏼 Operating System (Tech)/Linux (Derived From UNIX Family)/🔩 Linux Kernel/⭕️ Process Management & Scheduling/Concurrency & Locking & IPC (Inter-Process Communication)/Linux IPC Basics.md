# Linux IPC Basics

[TOC]



## Res
📂 [Chapter 5 Interprocess Communication Mechanisms | TLDP](https://tldp.org/LDP/tlk/ipc/ipc.html)

### Related Topics
↗ [OS Level Programming /Process Management /IPC](../../../../📟%20OS%20Level%20Programming/🧱%20OS%20Level%20Programming%20with%20C%20&%20CPP/Process%20Management/IPC%20(Internal)/IPC%20(Internal).md)
↗ [Operating System (Theory) / Process Management /IPC](../../../../../🧬%20Computer%20System/Operating%20System%20(Theory)/Processes%20Management%20(CPU%20+%20Main%20Memory%20Resource)/IPC%20(Inter%20Process%20Communication)/IPC%20(Inter%20Process%20Communication).md)



## Intro
> 🔗 https://tldp.org/LDP/tlk/ipc/ipc.html

Processes communicate with each other and with the kernel to coordinate their activities. Linux supports a number of Inter-Process Communication (IPC) mechanisms. Signals and pipes are two of them but Linux also supports the System V IPC mechanisms named after the Unix TM release in which they first appeared.



## Basic IPC Mechanisms (?)
### 1️⃣ Signals
Signals are one of the oldest inter-process communication methods used by Unix TM systems. They are used to signal asynchronous events to one or more processes. A signal could be generated by a keyboard interrupt or an error condition such as the process attempting to access a non-existent location in its virtual memory. Signals are also used by the shells to signal job control commands to their child processes.



### 2️⃣ Pipes
#### Pipes, Anonymous Pipes
> 实现亲缘进程间的进程通信
> 
> - 只支持单向数据流;
> - 只能用于具有亲缘关系的进程之间;
> - 没有名字;
> - 管道的缓冲区是有限的(管道制存在于内存中，在管道创建时，为缓冲区分配一个页面大小，默认64KB);
> - 管道所传送的是无格式字节流;

Pipes then are **unidirectional byte streams** which connect the standard output from one process into the standard input of another process. Neither process is aware of this redirection and behaves just as it would normally. It is the shell which sets up these temporary pipes between the processes.

**In Linux**, a pipe is implemented using two file data structures which both point at the same **temporary VFS inode** which itself points at a physical page within memory. Figure below shows that each file data structure contains pointers to different file operation routine vectors; one for writing to the pipe, the other for reading from the pipe.

This hides the underlying differences from the generic system calls which read and write to ordinary files. As the writing process writes to the pipe, bytes are copied into the shared data page and when the reading process reads from the pipe, bytes are copied from the shared data page. Linux must synchronize access to the pipe. It must make sure that the reader and the writer of the pipe are in step and to do this it uses locks, wait queues and signals.


![Pipes](https://www.science.unitn.it/~fiorella/guidelinux/tlk/img38.gif)
<small>Linux Pipes</small>


#### Named Pipes, FIFO
> 实现任意进程间的进程通信
> 
> 不同于管道之处在于它提供一个路径名与之关联，以FIFO的文件形式存在于文件系统中。这样，即使与FIFO的创建进程不存在亲缘关系的 进程，只要可以访问该路径，就能够彼此通过FIFO相互通信(能够访问该路径的进程以及 FIFO的创建进程之间)，因此，通过FIFO不相关的进程也能交换数据。值得注意的是，FIFO 严格遵循先进先出(first in first out)，对管道及FIFO的读总是从开始处返回数据，对它们的写则把数据添加到末尾。
> 
> 有名管道比管道多了一个打开操作:open。
> FIFO的打开规则:
> - 如果当前打开操作是为读而打开FIFO时，若已经有相应进程为写而打开该FIFO，则当前打开操作将成功返回; 否则，可能阻塞直到有相应进程为写而打开该FIFO(当前打开操作设置了阻塞标志);或者，成功返回 (当前打开操作没有设置阻塞标志)。
> - 如果当前打开操作是为写而打开FIFO时，如果已经有相应进程为读而打开该FIFO，则当前打开操作将成功返回; 否则，可能阻塞直到有相应进程为读而打开该FIFO(当前打开操作设置了阻塞标志);或者，返回 ENXIO错误(当前打开操作没有设置阻塞标志)。



## IPC Mechanism Inherited from System V
Linux supports three types of interprocess communication mechanisms that first appeared in Unix TM System V (1983). These are **message queues**, **semaphores** and **shared memory**. 

These System V IPC mechanisms all share common authentication methods. 
- Processes may access these resources only by passing a unique reference identifier to the kernel via system calls.
- Access to these System V IPC objects is checked using **access permissions**, much like accesses to files are checked. The access rights to the System V IPC object is set by the creator of the object via system calls.
- The object's reference identifier is used by each mechanism as an index into a table of resources. It is not a straight forward index but requires some manipulation to generate the index.
- All Linux data structures representing System V IPC objects in the system include an `ipc_perm` structure which contains the owner and creator process's user and group identifiers, the access mode for this object (owner, group and other) and the IPC object's key. 
	- The key is used as a way of locating the System V IPC object's reference identifier. Two sets of keys are supported: public and private. 
		- If the key is public then any process in the system, subject to rights checking, can find the reference identifier for the System V IPC object. 
		- System V IPC objects can never be referenced with a key, only by their reference identifier.


### 3️⃣ Message Queues
> 消息队列是一个存放在内核中的消息链表，每个消息队列由消息队列标识符标识。与管道不同的是消 息队列存放在内核中，只有在内核重启(即操作系 统重启)或者显示地删除一个消息队列时，该消息 队列才会被真正删除。
> 
> 1. 默认情况下，整个系统最多允许有32000个消 息队列。  
> 2. 每个消息队列最大为16384字节。
> 3. 消息队列中的每个消息最大为8192字节。 这部分信息可在`/usr/include/linux/msg.h` 查看。
> 若要修改这些参数，需要
> 1. 修改相应系统库的头文件
> 2. 重新编译内核

Message queues allow one or more processes to write messages, which will be read by one or more reading processes. 

Linux maintains a list of message queues, the `msgque` vector; each element of which points to a `msqid_ds` data structure that fully describes the message queue. When message queues are created a new `msqid_ds` data structure is allocated from system memory and inserted into the vector.


![](../../../../../../../Assets/Pics/Pasted%20image%2020230416085017.png)
<small>System V IPC Message Queues</small>



![](../../../../../../../Assets/Pics/Pasted%20image%2020230416084913.png)
<small>Kernel Message Queue Resources</small>


### 4️⃣ Semaphores
In its simplest form a semaphore is a location in memory whose value can be tested and set by more than one process. The test and set operation is, so far as each process is concerned, **uninterruptible or atomic**; once started nothing can stop it. The result of the test and set operation is the addition of the current value of the semaphore and the set value, which can be positive or negative. Depending on the result of the test and set operation one process may have to sleep until the semphore's value is changed by another process. Semaphores can be used to implement _critical regions_, areas of critical code that only one process at a time should be executing.


### 5️⃣ Shared Memory
Shared memory allows one or more processes to communicate via memory that appears in all of their virtual address spaces. The pages of the virtual memory is referenced by page table entries in each of the sharing processes' page tables. It does not have to be at the same address in all of the processes' virtual memory. 
As with all System V IPC objects, access to shared memory areas is controlled via keys and access rights checking. ==Once the memory is being shared, there are no checks on how the processes are using it. They must rely on other mechanisms, for example System V semaphores, to synchronize access to the memory.==



## IPC Mechanism Introduced by BSD
### 6️⃣ Sockets
↗ [Socket Programming & RPC](../../../../../🏎️%20Computer%20Networking%20and%20Communication/🎅🏼%20Socket%20Programming%20&%20RPC/Socket%20Programming%20&%20RPC.md)



## Ref
[进程间通信（IPC）介绍]: https://www.cnblogs.com/CheeseZH/p/5264465.html

[进程间通信和线程间通信总结]: https://blog.csdn.net/J080624/article/details/87454764

[进程间通信和多线程通信的区别整理]: https://www.cnblogs.com/JCpeng/p/15037359.html

[Demangling message queues]: http://sunsite.uakom.sk/sunworldonline/swol-11-1997/swol-11-insidesolaris.html

